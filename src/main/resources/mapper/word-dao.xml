<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.ulv.pro.langen.dao.WordDao">
	
	<resultMap id="wordMap" type="Word">
		<id     property="id"       	column="id" />
		<result property="name" 		column="word" />
		<result property="languageId" 	column="language_id" />
		<result property="createdDate" 	column="created_date" />
		
		<!-- <association property="group" javaType="WordGroup">
			<id     property="id"        	column="group_id" />
			<result property="name" 		column="group_name" />
			<result property="languageId" 	column="group_language_id" />
		</association> -->
	</resultMap>
	
	<resultMap id="wordDeepMap" type="Word">
		<id     property="id"       	column="id" />
		<result property="name" 		column="word" />
		<result property="languageId" 	column="language_id" />
		<result property="createdDate" 	column="created_date" />
		
		<collection property="categories" ofType="WordCategory">
			<id     property="id"        	column="fn_id" />
			<result property="name" 		column="fn_name" />
			<result property="descr" 		column="fn_descr" />
			<result property="categoryType" column="fn_category_type" 
				typeHandler="org.ulv.pro.langen.handler.WordCategoryTypeHandler"/>
		</collection>
<!-- 		<collection property="categories" ofType="Lexer"> -->
<!-- 			<id     property="id"        	column="cat_id" /> -->
<!-- 			<result property="name" 		column="cat_name" /> -->
<!-- 			<result property="descr" 		column="cat_descr" /> -->
<!-- 		</collection> -->
	</resultMap>
	
	<sql id="wordColumns"> 
		${alias}.id,
		${alias}.word, 
		${alias}.language_id,
		${alias}.created_date
	</sql>
	<sql id="functionColumns"> 
		${alias}.id as fn_id,
		${alias}.lex_name as fn_name, 
		${alias}.descr as fn_descr, 
		${catAlias}.category_type as fn_category_type
	</sql>
	<sql id="categoryColumns"> 
		${alias}.id as cat_id,
		${alias}.lex_name as cat_name, 
		${alias}.descr as cat_descr
	</sql>
	<sql id="joinFunctions">
		LEFT JOIN word_functions fn ON fn.word_id = ${alias}.id 
		LEFT JOIN lexers lxfn ON lxfn.id = ${aliasFn}.function_id
	</sql>
	<sql id="joinCategories">
		LEFT JOIN word_categories cat ON cat.word_id = ${alias}.id 
		LEFT JOIN lexers lxcat ON lxcat.id = ${aliasCat}.category_id
	</sql>
	
	<sql id="whereAll">
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="id != null">
				AND ${alias}.id = #{id}
			</if>
			<if test="name != null">
				AND ${alias}.word = #{name}
			</if>
			<if test="languageId != null">
				AND ${alias}.language_id = #{languageId}
			</if>
		</trim>
	</sql>
			<!-- ,
			<include refid="groupColumns"><property name="alias" value="g"/></include> -->
	<select id="getWordsByFunction" parameterType="LexerLang" resultMap="wordDeepMap">
		SELECT 
			<include refid="wordColumns"><property name="alias" value="w"/></include>,
			<include refid="functionColumns"><property name="alias" value="lxcat"/><property name="catAlias" value="cat"/></include>
		FROM words w
			<include refid="joinCategories"><property name="alias" value="w"/><property name="aliasCat" value="cat"/></include>
		WHERE lxcat.id = #{id}
		AND w.language_id = #{languageId}
	</select>
	
	<select id="getWordsTop10" parameterType="Word" resultMap="wordMap">
		SELECT 
			<include refid="wordColumns"><property name="alias" value="w"/></include>
		FROM words w
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="id != null">
				AND w.id = #{id}
			</if>
			<if test="name != null">
				AND w.word = #{name}
			</if>
			<if test="languageId != null">
				AND w.language_id = #{languageId}
			</if>
		</trim>
		ORDER BY created_date DESC LIMIT 10
	</select>
	
	<select id="getWords" parameterType="Word" resultMap="wordMap">
		SELECT 
			<include refid="wordColumns"><property name="alias" value="w"/></include>
		FROM words w
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="id != null">
				AND w.id = #{id}
			</if>
			<if test="name != null">
				AND w.word = #{name}
			</if>
			<if test="languageId != null">
				AND w.language_id = #{languageId}
			</if>
		</trim>
		ORDER BY w.word
	</select>
	
	<select id="getWordsWithGroups" parameterType="Word" resultMap="wordDeepMap">
		SELECT 
			<include refid="wordColumns"><property name="alias" value="w"/></include>,
			<include refid="functionColumns">
				<property name="alias" value="lxcat"/>
				<property name="catAlias" value="cat"/>
			</include>
		FROM words w
			<include refid="joinCategories"><property name="alias" value="w"/><property name="aliasCat" value="cat"/></include>
		<include refid="whereAll"><property name="alias" value="w"/></include>
		ORDER BY w.word
	</select>
	
	<select id="getWordById" parameterType="integer" resultMap="wordDeepMap">
		SELECT
			<include refid="wordColumns"><property name="alias" value="w"/></include>,
			<include refid="functionColumns">
				<property name="alias" value="lxcat"/>
				<property name="catAlias" value="cat"/>
			</include>
		FROM words w
			<include refid="joinCategories">
				<property name="alias" value="w"/>
				<property name="aliasCat" value="cat"/>
			</include>
		WHERE w.id = #{value}
	</select>
	
	<insert id="addWord" parameterType="Word">
		INSERT INTO words (word, language_id)
		VALUES (#{name}, #{languageId})
	</insert>
	
	<insert id="assignCategory" parameterType="WordAssign">
		INSERT INTO word_categories (word_id, category_id, category_type) 
		VALUES (#{wordId}, #{lexerId}, #{categoryType.code})
	</insert>
	
	<delete id="removeLexer" parameterType="WordAssign">
		DELETE FROM word_categories 
		WHERE word_id = #{wordId} AND category_id = #{lexerId}
	</delete>
	
</mapper>